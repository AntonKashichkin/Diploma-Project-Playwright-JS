name: Notify

on:
  workflow_run:
    workflows: ["API Tests", "E2E Tests"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # 1. –°–∫–∞—á–∏–≤–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      # 2. –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      - name: Build Telegram message
        id: build_message
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

          API_FILE="artifacts/summary-api/summary.json"
          E2E_FILE="artifacts/summary-e2e/summary.json"

          MESSAGE="üì¢ *Test Run Completed*\n\n"

          build_block() {
            NAME=$1
            FILE=$2
            if [ ! -f "$FILE" ]; then
              echo ""
              return
            fi

            PASSED=$(jq '.statistic.passed' "$FILE")
            FAILED=$(jq '.statistic.failed' "$FILE")
            BROKEN=$(jq '.statistic.broken' "$FILE")
            SKIPPED=$(jq '.statistic.skipped' "$FILE")
            DURATION=$(jq '.time.duration' "$FILE")

            echo "*$NAME*\n‚úÖ Passed: $PASSED\n‚ùå Failed: $FAILED\nüí• Broken: $BROKEN\n‚ö™ Skipped: $SKIPPED\n‚è± Duration: ${DURATION} ms\n\n"
          }

          # –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ API
          MESSAGE="$MESSAGE$(build_block "API Tests" "$API_FILE")"

          # –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ E2E
          MESSAGE="$MESSAGE$(build_block "E2E Tests" "$E2E_FILE")"

          MESSAGE="${MESSAGE}üîó *Allure Report:* ${REPORT_URL}index.html"

          mkdir message
          echo "$MESSAGE" > message/text.txt

      # 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Telegram
      - name: Send Telegram
        env:
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        run: |
          TEXT=$(cat message/text.txt)
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${TG_CHAT_ID}\",\"text\":\"${TEXT}\",\"parse_mode\":\"Markdown\"}" \
            https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage

